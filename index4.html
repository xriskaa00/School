
<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Krvav√Ω K√∫can</title>
    <!-- D√¥le≈æit√©: spr√°vne script tagy -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,700;1,400&display=swap');

        body { 
            background: #0a0a0f; 
            color: #d4c5aa; 
            font-family: 'Crimson Text', serif;
            height: 100vh; 
            overflow: hidden;
            position: relative;
            transition: background 1s ease;
        }

        /* ATMOSF√âRICK√ù POPOL (EMBERS) */
        .embers {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #ff4d4d, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, #ffffff, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 50px 160px, #ff8080, rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 40px, #ff4d4d, rgba(0,0,0,0));
            background-size: 200px 200px;
            animation: fly-embers 10s linear infinite;
            opacity: 0.4;
        }
        @keyframes fly-embers { from { background-position: 0 0; } to { background-position: 0 -200px; } }

        /* Ostatn√© pozadie */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 0, 0, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(25, 25, 112, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        .grid-layout { 
            display: grid; 
            grid-template-columns: 320px 1fr 360px; 
            grid-template-rows: 80px 1fr; 
            height: 100vh;
            position: relative;
            z-index: 2;
        }

        header { 
            transition: all 0.7s ease; 
            border-bottom: 3px solid;
            background: linear-gradient(135deg, #1a0f0f 0%, #0f0a1a 100%);
            position: relative;
            overflow: hidden;
        }
        header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(139, 0, 0, 0.1), transparent);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer { 0%, 100% { transform: translateX(-100%); } 50% { transform: translateX(100%); } }

        header.is-day { 
            background: linear-gradient(135deg, #1a1a3a 0%, #0f1a2a 100%);
            border-bottom-color: #4a90e2;
            box-shadow: inset 0 0 60px rgba(74, 144, 226, 0.15);
        }
        header.is-night { 
            background: linear-gradient(135deg, #2a0a0a 0%, #1a0a1a 100%);
            border-bottom-color: #8b0000;
            box-shadow: inset 0 0 60px rgba(139, 0, 0, 0.2);
            animation: night-pulse 4s infinite;
        }
        @keyframes night-pulse {
            0%, 100% { box-shadow: inset 0 0 60px rgba(139, 0, 0, 0.2); }
            50% { box-shadow: inset 0 0 80px rgba(139, 0, 0, 0.35); }
        }

        .time-badge { 
            padding: 10px 24px; 
            border-radius: 12px; 
            font-weight: 900; 
            font-size: 15px; 
            letter-spacing: 3px;
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .badge-day { 
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: #fff; 
            box-shadow: 0 0 30px rgba(74, 144, 226, 0.6), 0 4px 20px rgba(0,0,0,0.5);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .badge-night { 
            background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%);
            color: #ffebcd; 
            box-shadow: 0 0 30px rgba(139, 0, 0, 0.7), 0 4px 20px rgba(0,0,0,0.5);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: badge-glow 2s infinite;
        }
        @keyframes badge-glow { 0%, 100% { box-shadow: 0 0 30px rgba(139, 0, 0, 0.7), 0 4px 20px rgba(0,0,0,0.5); } 50% { box-shadow: 0 0 50px rgba(139, 0, 0, 0.9), 0 4px 20px rgba(0,0,0,0.5); } }

        @keyframes rotate {
            0% { transform: translate(-50%, -100%) rotate(0deg); }
            100% { transform: translate(-50%, -100%) rotate(360deg); }
        }

        .alive-counter {
            font-family: 'Cinzel', serif;
            font-size: 12px;
            font-weight: bold;
            color: #9ca3af;
            background: rgba(0,0,0,0.5);
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid #374151;
            margin-left: 10px;
        }

        .sidebar { 
            background: linear-gradient(180deg, #0f0a15 0%, #1a0f1a 100%);
            border: 2px solid #2a1f2f;
            overflow-y: auto; 
            padding: 20px;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.5);
        }

        .main-area { 
            background: 
                radial-gradient(circle at center, rgba(26, 26, 46, 0.4) 0%, rgba(10, 10, 15, 0.6) 70%),
                url('https://i.postimg.cc/VrZjd2Vw/image.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
        }
        .main-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 30%, rgba(139, 0, 0, 0.05) 100%);
            pointer-events: none;
        }

        /* KULAT√ù ST√îL - OKULTN√ù DIZAJN */
        .round-table {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35%;
            aspect-ratio: 1;
            border-radius: 50%;
            background: 
                radial-gradient(circle at center, transparent 30%, #000 100%),
                url('https://www.transparenttextures.com/patterns/black-scales.png'),
                linear-gradient(135deg, #2a1a1a 0%, #0f0505 100%);
            border: 8px solid #3a2020;
            box-shadow: 0 0 80px rgba(139, 0, 0, 0.2), inset 0 0 100px #000;
            z-index: 5;
            cursor: pointer;
        }
        .round-table::before {
            content: '';
            position: absolute;
            inset: 10px;
            border-radius: 50%;
            border: 2px dashed rgba(139, 0, 0, 0.3);
            background: transparent;
            animation: rotate-runes 60s linear infinite;
            opacity: 0.6;
        }
        .round-table::after {
            content: '';
            position: absolute;
            inset: 25%;
            border-radius: 50%;
            border: 1px dotted rgba(255, 255, 255, 0.1);
            animation: rotate-runes 40s linear infinite reverse;
        }
        @keyframes rotate-runes { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .player-card { 
            position: absolute; 
            width: 120px; 
            transform: translate(-50%, -50%); 
            z-index: 10; 
            text-align: center; 
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
        }

        /* UPRAVEN√ù SPOTLIGHT EFEKT - Jemnej≈°√≠ */
        .grid-layout.has-nomination .player-card:not(.nominated) {
            filter: brightness(0.65) saturate(0.8);
            opacity: 0.9;
            transform: translate(-50%, -50%) scale(0.95);
        }
        .grid-layout.has-nomination .player-card.nominated {
            z-index: 20;
            filter: brightness(1.15) drop-shadow(0 0 25px rgba(220, 38, 38, 0.5));
            transform: translate(-50%, -50%) scale(1.15);
        }

        .token { 
            width: 85px; 
            height: 85px; 
            border-radius: 50%; 
            border: 4px solid #3a2f3f;
            background: radial-gradient(circle at 30% 30%, #2a2a3a 0%, #0f0a1a 100%);
            margin: 0 auto 8px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            cursor: pointer; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 2px 4px rgba(255,255,255,0.1);
        }
        .token:hover { transform: scale(1.1); filter: brightness(1.2); }

        .border-villager { 
            border-color: #2d5a2d !important;
            background: radial-gradient(circle at 30% 30%, #1a3a1a 0%, #0a1a0a 100%);
            box-shadow: 0 0 25px rgba(45, 90, 45, 0.5), inset 0 2px 4px rgba(45, 200, 45, 0.2);
        }
        .border-outsider { 
            border-color: #8b5a00 !important;
            background: radial-gradient(circle at 30% 30%, #3a2a1a 0%, #1a1a0a 100%);
            box-shadow: 0 0 25px rgba(139, 90, 0, 0.5), inset 0 2px 4px rgba(249, 115, 22, 0.2);
        }
        .border-evil { 
            border-color: #8b0000 !important;
            background: radial-gradient(circle at 30% 30%, #3a0a0a 0%, #1a0a0a 100%);
            box-shadow: 0 0 25px rgba(139, 0, 0, 0.6), inset 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        /* DIZAJN SMRTI */
        .dead .token {
            box-shadow: 0 0 0 4px #8b0000, 0 0 25px rgba(170, 0, 0, 0.6) !important;
            transition: all 0.6s ease;
            position: relative;
        }
        .dead .token::after { display: none; }
        .player-card.dead .text-xs {
            color: #ef4444 !important;
            text-decoration: line-through;
            text-decoration-thickness: 3px;
            text-decoration-color: #ff0000;
            font-weight: 900;
            opacity: 0.9;
            text-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
        }

        /* HLASOVANIE - √öDER RUKOU */
        .paprcka { 
            position: absolute; 
            top: -40px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 45px; 
            z-index: 100; 
            animation: hand-slam 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6));
        }
        @keyframes hand-slam { 
            0% { transform: translate(-50%, -50px) scale(1.5); opacity: 0; } 
            70% { transform: translate(-50%, 0) scale(0.9); opacity: 1; }
            100% { transform: translate(-50%, -10px) scale(1); } 
        }

        .nomination-arrow { 
            position: absolute; 
            top: -80px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 55px; 
            z-index: 150; 
            animation: arrow-pulse 1s ease-in-out infinite;
            filter: drop-shadow(0 0 12px rgba(139, 0, 0, 0.9));
        }
        @keyframes arrow-pulse { 
            0%, 100% { transform: translate(-50%, 0) scale(1); } 
            50% { transform: translate(-50%, -10px) scale(1.15); } 
        }

        /* Tlaƒçidl√° hlasovania ‚Äì z√°klad */
        .vote-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 18px;
        }
        .vote-yes { background: #22c55e; color: white; }
        .vote-yes:hover { background: #16a34a; }
        .vote-no { background: #ef4444; color: white; }
        .vote-no:hover { background: #dc2626; }

        .vote-token {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            z-index: 25;
            border: 2px solid white;
        }
        .yes-token { background: #eab308; }
        .no-token { background: #a855f7; font-size: 16px; }

        .voting-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 2px solid #555;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        .voting-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.7);
        }
        .voting-card.voted-yes {
            border-color: #22c55e;
            background: linear-gradient(135deg, #1a2a1a 0%, #0a1a0a 100%);
        }
        .voting-card.voted-no {
            border-color: #ef4444;
            background: linear-gradient(135deg, #2a1a1a 0%, #1a0a0a 100%);
        }

        .chat-box { 
            background: linear-gradient(135deg, #0a0a15 0%, #15091a 100%);
            height: 130px; 
            overflow-y: auto; 
            font-size: 12px; 
            padding: 10px; 
            border: 2px solid #2a1f2f;
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            gap: 6px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }
        .msg { 
            padding: 6px 12px; 
            border-radius: 6px; 
            max-width: 85%; 
            font-size: 12px; 
            color: #d4c5aa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .msg-me { 
            background: linear-gradient(135deg, #3a0a0a 0%, #2a0505 100%);
            align-self: flex-end; 
            border: 1px solid #5a0000;
        }
        .msg-them { 
            background: linear-gradient(135deg, #1a1a3a 0%, #0f0f2a 100%);
            align-self: flex-start; 
            border: 1px solid #2a2a5a;
        }

        .player-note { 
            position: absolute; 
            bottom: -14px; 
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white; 
            font-size: 8px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: bold; 
            text-transform: uppercase; 
            z-index: 50;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .status-badge { 
            position: absolute; 
            top: -12px; 
            right: -12px; 
            background: linear-gradient(135deg, #1a0a0a 0%, #0a0a1a 100%);
            border-radius: 14px; 
            padding: 3px 8px; 
            min-width: 28px; 
            height: 28px; 
            font-size: 13px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 2px solid #3a2f3f;
            z-index: 60;
            white-space: nowrap; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.6);
        }

        /* Lobby Screen */
        #lobby {
            background: 
                linear-gradient(135deg, rgba(10, 10, 15, 0.5) 0%, rgba(26, 10, 26, 0.6) 100%),
                url('https://mcdn.wallpapersafari.com/medium/84/74/xN1gOb.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            will-change: background-position;
            animation: bg-shift 30s ease-in-out infinite;
        }
        @keyframes bg-shift { 0%, 100% { background-position: center; } 50% { background-position: 52% 48%; } }
        #lobby::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 20%, rgba(0,0,0,0.3) 80%);
            pointer-events: none;
        }
        #lobby::after {
            content: '';
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 80% 20%, rgba(139, 0, 0, 0.1) 0%, transparent 25%);
            animation: glow-pulse 4s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes glow-pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }

        .lobby-box { animation: box-entrance 1s ease-out; will-change: transform, opacity; }
        @keyframes box-entrance { 0% { opacity: 0; transform: translateY(-50px) scale(0.9); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .lobby-title { animation: title-entrance 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) both; will-change: transform, opacity; text-shadow: 3px 3px 0px rgba(0,0,0,0.8), 0 0 30px rgba(139, 0, 0, 0.6); }
        @keyframes title-entrance {
            0% { opacity: 0; transform: scale(2) translateY(-50px); text-shadow: 0 0 10px rgba(139, 0, 0, 0.5); }
            100% { opacity: 1; transform: scale(1) translateY(0); text-shadow: 3px 3px 0px rgba(0,0,0,0.8), 0 0 30px rgba(139, 0, 0, 0.6); }
        }
        .lobby-input { animation: input-entrance 0.6s ease-out backwards; position: relative; }
        .lobby-input:nth-child(1) { animation-delay: 0.4s; }
        .lobby-input:nth-child(2) { animation-delay: 0.6s; }
        @keyframes input-entrance { 0% { opacity: 0; transform: translateX(-30px); } 100% { opacity: 1; transform: translateX(0); } }
        .lobby-button { animation: button-entrance 0.6s ease-out backwards; position: relative; overflow: hidden; }
        .lobby-button:nth-child(1) { animation-delay: 0.8s; }
        .lobby-button:nth-child(2) { animation-delay: 1.0s; }
        @keyframes button-entrance { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        .lobby-input:focus { box-shadow: 0 0 30px rgba(139, 0, 0, 0.5), 0 0 60px rgba(139, 0, 0, 0.2); border-color: #8b0000 !important; }
        .input-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; opacity: 0.6; pointer-events: none; z-index: 10; }
        @keyframes footer-fade { 0% { opacity: 0; } 100% { opacity: 1; } }

        #lobby h1 { font-family: 'Cinzel', serif; text-shadow: 3px 3px 0px rgba(0,0,0,0.8), 0 0 30px rgba(139, 0, 0, 0.8); }
        button { font-family: 'Cinzel', serif; letter-spacing: 1px; transition: all 0.3s ease; position: relative; overflow: hidden; }
        button::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s;
        }
        button:hover::before { width: 300px; height: 300px; }
        input { font-family: 'Crimson Text', serif; transition: all 0.3s ease; }
        input:focus { box-shadow: 0 0 20px rgba(139, 0, 0, 0.3); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0f; border-left: 1px solid #2a1f2f; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #5a0000 0%, #3a0000 100%); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #8b0000 0%, #5a0000 100%); }

        .section-header { font-family: 'Cinzel', serif; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .role-section { background: linear-gradient(135deg, rgba(26, 15, 26, 0.3) 0%, rgba(15, 10, 26, 0.3) 100%); border: 1px solid #2a1f2f; border-radius: 6px; padding: 4px 6px; margin-bottom: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* ST Kompaktn√° tabuƒæka */
        .st-table { width: 100%; border-collapse: collapse; font-size: 9px; }
        .st-table th {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.3) 0%, rgba(90, 0, 0, 0.3) 100%);
            color: #d4c5aa;
            padding: 3px 4px;
            text-align: left;
            border: 1px solid #3a2f3f;
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            font-weight: 900;
            letter-spacing: 0.5px;
        }
        .st-table td {
            padding: 3px 4px;
            border: 1px solid #2a1f2f;
            background: linear-gradient(135deg, rgba(26, 15, 26, 0.2) 0%, rgba(15, 10, 26, 0.2) 100%);
        }
        .st-table tr:hover td {
            background: linear-gradient(135deg, rgba(26, 15, 26, 0.5) 0%, rgba(15, 10, 26, 0.5) 100%);
        }

        .chat-contact {
            background: linear-gradient(135deg, rgba(26, 15, 26, 0.5) 0%, rgba(15, 10, 26, 0.5) 100%);
            border: 2px solid #2a1f2f;
            border-radius: 6px;
            padding: 6px 10px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .chat-contact:hover {
            background: linear-gradient(135deg, rgba(26, 15, 26, 0.8) 0%, rgba(15, 10, 26, 0.8) 100%);
            border-color: #8b0000;
            transform: translateX(3px);
        }
        .chat-contact.active {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.3) 0%, rgba(90, 0, 0, 0.3) 100%);
            border-color: #8b0000;
            box-shadow: 0 0 10px rgba(139, 0, 0, 0.4);
        }
        .unread-badge {
            position: absolute;
            top: 4px;
            right: 6px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-size: 9px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
            animation: badge-pulse 2s infinite;
        }
        @keyframes badge-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .chat-view { display: none; flex-direction: column; height: 100%; }
        .chat-view.active { display: flex; }
        .chat-contacts-list { max-height: none; overflow-y: auto; flex: 1; }

        /* ===== ATMOSF√âRICK√â HLASOVACIE TLAƒåIDL√Å (√ÅNO / NIE) ===== */
        .vote-btn {
            position: relative;
            padding: 12px 26px;
            border-radius: 12px;
            font-weight: 800;
            font-family: 'Cinzel', serif;
            letter-spacing: 1.6px;
            text-transform: uppercase;
            border: 1.5px solid rgba(139, 0, 0, 0.6);
            box-shadow: 0 0 0 1px rgba(0,0,0,0.65), 0 10px 24px rgba(0,0,0,0.6);
            transition: transform .15s ease, box-shadow .25s ease, filter .25s ease;
            backdrop-filter: blur(2px);
            overflow: hidden;
        }
        .vote-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -120%;
            width: 60%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
            transform: skewX(-20deg);
            transition: left .9s ease;
            pointer-events: none;
        }
        .vote-btn::after {
            content: '';
            position: absolute;
            bottom: -10px; left: 22%;
            width: 68px; height: 14px;
            background:
                radial-gradient(6px 6px at 12px 6px, rgba(139,0,0,0.85) 40%, transparent 41%),
                radial-gradient(4px 4px at 26px 3px, rgba(170, 0, 0, 0.75) 40%, transparent 41%),
                radial-gradient(5px 5px at 46px 5px, rgba(120, 0, 0, 0.7) 40%, transparent 41%);
            filter: blur(0.4px);
            opacity: .9;
            transition: transform .2s ease, opacity .2s ease;
        }
        .vote-btn:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 0 22px rgba(139,0,0,0.45), 0 14px 28px rgba(0,0,0,0.72);
            filter: saturate(1.15);
            animation: vote-glitch 0.35s ease;
        }
        .vote-btn:hover::before { left: 120%; }
        .vote-btn:hover::after { transform: translateY(-2px); }
        @keyframes vote-glitch {
            0%   { transform: translateY(-1px) scale(1.02) skewX(0deg); }
            25%  { transform: translate(0.6px, -1.4px) scale(1.02) skewX(1deg); }
            50%  { transform: translate(-0.6px, -0.6px) scale(1.02) skewX(-1deg); }
            75%  { transform: translate(0.4px, -1.0px) scale(1.02) skewX(0.5deg); }
            100% { transform: translateY(-1px) scale(1.02) skewX(0deg); }
        }
        .vote-yes {
            background: radial-gradient(circle at 20% 20%, rgba(34, 197, 94, 0.3) 0%, transparent 50%),
                        linear-gradient(135deg, #0f2a16 0%, #1c4a2a 50%, #256f3d 100%);
            color: #f9ebd7;
            text-shadow: 0 1px 2px rgba(0,0,0,0.7);
            border-color: rgba(34, 197, 94, 0.6);
            box-shadow: 0 0 14px rgba(34,197,94,0.28), 0 10px 22px rgba(0,0,0,0.7);
        }
        .vote-yes:hover {
            background: radial-gradient(circle at 70% 30%, rgba(72, 232, 140, 0.18) 0%, transparent 50%),
                        linear-gradient(135deg, #12321b 0%, #205835 55%, #2c7d47 100%);
            box-shadow: 0 0 20px rgba(72,232,140,0.35), 0 14px 28px rgba(0,0,0,0.75);
        }
        .vote-no {
            background: radial-gradient(circle at 20% 20%, rgba(239, 68, 68, 0.32) 0%, transparent 50%),
                        linear-gradient(135deg, #2a0f0f 0%, #4a1c1c 50%, #6f2525 100%);
            color: #f9ebd7;
            text-shadow: 0 1px 2px rgba(0,0,0,0.7);
            border-color: rgba(239, 68, 68, 0.65);
            box-shadow: 0 0 14px rgba(239,68,68,0.28), 0 10px 22px rgba(0,0,0,0.7);
        }
        .vote-no:hover {
            background: radial-gradient(circle at 70% 30%, rgba(255, 120, 120, 0.18) 0%, transparent 50%),
                        linear-gradient(135deg, #331313 0%, #5a2222 55%, #802c2c 100%);
            box-shadow: 0 0 20px rgba(255,120,120,0.35), 0 14px 28px rgba(0,0,0,0.75);
        }

        /* ===== TIMER OVERLAY ===== */
        .timer-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 50; /* nad tokenmi */
        }
        .timer-ring {
            width: 60%;
            aspect-ratio: 1;
            border-radius: 50%;
            background: conic-gradient(#b01414 var(--pct, 0%), rgba(255,255,255,0.08) 0);
            box-shadow: 0 0 60px rgba(176, 20, 20, 0.25), inset 0 0 60px rgba(0,0,0,0.6);
            display: grid;
            place-items: center;
        }
        .timer-core {
            width: 75%;
            aspect-ratio: 1;
            border-radius: 50%;
            background: radial-gradient(circle at 45% 45%, rgba(0,0,0,0.8) 0%, rgba(30,0,0,0.6) 65%, rgba(0,0,0,0.8) 100%);
            border: 3px solid rgba(176,20,20,0.35);
            display: grid;
            place-items: center;
        }
        .timer-text {
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: clamp(20px, 3vw, 36px);
            color: #f4e5cf;
            text-shadow: 0 2px 6px rgba(0,0,0,0.7);
        }
        .timer-mini {
            margin-top: 6px;
            font-size: clamp(10px, 1.4vw, 14px);
            color: #bda48b;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        @keyframes table-flash {
            0%, 100% { box-shadow: 0 0 80px rgba(139,0,0,0.2), inset 0 0 100px #000; }
            50% { box-shadow: 0 0 100px rgba(255,0,0,0.7), inset 0 0 140px #000; }
        }
        .table-flash { animation: table-flash 1s ease 3; }
    </style>
</head>
<body>

<div class="embers"></div>

<!-- Lobby -->
<div id="lobby" class="fixed inset-0 z-[3000] flex items-center justify-center p-6 text-center">
    <div class="lobby-box bg-gradient-to-br from-gray-900/95 via-black/95 to-gray-900/95 p-12 rounded-3xl border-2 border-red-900 w-full max-w-md shadow-2xl relative backdrop-blur-sm">
        <div class="absolute inset-0 rounded-3xl opacity-20" style="background: radial-gradient(circle at center, rgba(139,0,0,0.3), transparent);"></div>
        
        <h1 class="lobby-title relative text-5xl font-black text-red-700 mb-8 uppercase italic tracking-widest">KRVAV√ù K√öCAN</h1>
        
        <div class="lobby-input relative mb-4">
            <div class="input-icon">üö™</div>
            <input id="joinRoom" type="text" placeholder="K√ìD MIESTNOSTI" class="w-full bg-black/80 p-5 pl-14 border-2 border-gray-800 rounded-xl text-white uppercase outline-none font-bold tracking-wider backdrop-blur-sm transition-all duration-300 lobby-input">
        </div>
        
        <div class="lobby-input relative mb-6">
            <div class="input-icon">üë§</div>
            <input id="joinName" type="text" placeholder="TVOJE MENO" class="w-full bg-black/80 p-5 pl-14 border-2 border-gray-800 rounded-xl text-white outline-none tracking-wide backdrop-blur-sm transition-all duration-300 lobby-input">
        </div>
        
        <button onclick="enterGame(false)" class="lobby-button relative w-full bg-gradient-to-r from-red-700 to-red-600 hover:from-red-600 hover:to-red-500 p-5 rounded-xl font-bold mb-3 uppercase transition-all duration-300 shadow-lg hover:shadow-red-900/50 hover:scale-105">
            üé≠ Vst√∫pi≈• ako Hr√°ƒç
        </button>
        
        <button onclick="enterGame(true)" class="lobby-button relative w-full bg-gradient-to-r from-red-900/50 to-red-800/50 hover:from-red-900/70 hover:to-red-800/70 p-5 rounded-xl font-bold border-2 border-red-700 uppercase transition-all duration-300 shadow-lg hover:scale-105">
            üìñ Storyteller
        </button>
        
        <div class="mt-6 text-center text-gray-500 text-[10px] uppercase tracking-widest" style="font-family: 'Cinzel', serif; opacity: 0.6; animation: footer-fade 1.5s ease-out 1.4s both;">
            By JumalaLuke &amp; Yuuki
        </div>
    </div>
</div>

<!-- Game Grid -->
<div id="gameRoot" class="hidden grid-layout">
    <header id="mainHeader" class="col-span-3 flex items-center justify-between px-8">
        <div class="flex items-center gap-4 text-sm">
            <div class="text-white font-black uppercase bg-black/60 px-5 py-2 rounded-lg italic border border-red-900/30 shadow-lg" style="font-family: 'Cinzel', serif; letter-spacing: 2px;">KRVAV√ù K√öCAN</div>
            <div id="myInfo" class="text-gray-300 font-medium tracking-wide"></div>
        </div>
        
        <div id="stControls" class="hidden flex gap-3">
            <button onclick="distributeRoles()" class="st-btn st-btn-roles">
                <span>üîÆ</span> Rozda≈• Osud
            </button>
            <button onclick="toggleTime()" class="st-btn st-btn-time">
                <span>üåó</span> Cyklus
            </button>
            <button onclick="hardReset()" class="st-btn st-btn-reset">
                <span>‚ò†Ô∏è</span> Z√°nik
            </button>
        </div>

        <div class="flex items-center gap-3">
            <div id="aliveCounter" class="alive-counter">≈Ωiv√≠: ?</div>
            <div id="curTime" class="time-badge">DE≈á</div>
        </div>
    </header>

    <aside class="sidebar"><div id="roleList" class="space-y-4 text-xs"></div></aside>

    <main class="main-area">
        <div id="roundTable" class="round-table" title="Klikni (ST) pre nastavenie odpoƒçtu">
            <div id="votingButtons" class="hidden absolute inset-0 flex items-center justify-center gap-6 z-10">
                <button id="voteYesBtn" class="vote-btn vote-yes">√ÅNO</button>
                <button id="voteNoBtn" class="vote-btn vote-no">NIE</button>
            </div>

            <!-- TIMER OVERLAY -->
            <div id="timerOverlay" class="timer-overlay hidden">
                <div class="timer-ring" style="--pct:0%;">
                    <div class="timer-core">
                        <div class="timer-text" id="timerText">00:00</div>
                        <div class="timer-mini" id="timerMini">Odpoƒç√≠tavanie</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tableCircle" class="w-full h-full relative"></div>
    </main>

    <aside class="sidebar border-l-2 border-gray-800 flex flex-col gap-3">
        <h3 class="section-header text-xs font-black text-gray-500 border-b-2 border-gray-800 uppercase text-center pb-2">Po≈°ta</h3>
        <div id="chatContacts" class="hidden chat-contacts-list"></div>
        <div id="allChats" class="flex-1 overflow-y-auto"></div>
    </aside>
</div>

<!-- ST Modal -->
<div id="stModal" class="hidden fixed inset-0 bg-black/95 z-[4000] flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gradient-to-br from-gray-900 via-black to-gray-900 p-8 rounded-2xl border-2 border-red-900 w-full max-w-sm text-center shadow-2xl">
        <h2 id="targetName" class="text-2xl font-bold mb-6 text-white uppercase italic" style="font-family: 'Cinzel', serif;"></h2>
        <div class="grid grid-cols-2 gap-3 text-xs font-bold uppercase">
            <button onclick="stAction('is_nominated')" class="bg-gradient-to-r from-orange-600 to-orange-700 p-5 rounded-lg text-white col-span-2 text-base shadow-lg hover:from-orange-500 hover:to-orange-600 transition">üì¢ NOMINOVA≈§</button>
            <button onclick="stAction('is_dead')" class="bg-gradient-to-r from-red-600 to-red-700 p-5 rounded-lg text-white shadow-lg hover:from-red-500 hover:to-red-600 transition">Zabi≈• / O≈æivi≈•</button>
            <button onclick="stAction('status_drunk')" class="bg-gradient-to-r from-amber-700 to-amber-800 p-5 rounded-lg text-white shadow-lg hover:from-amber-600 hover:to-amber-700 transition">üç∫ OPIT√ù</button>
            <button onclick="stAction('status_poisoned')" class="bg-gradient-to-r from-purple-700 to-purple-800 p-5 rounded-lg text-white shadow-lg hover:from-purple-600 hover:to-purple-700 transition">üß™ OTR√ÅVEN√ù</button>
            <button onclick="stAction('status_protected')" class="bg-gradient-to-r from-blue-700 to-blue-800 p-5 rounded-lg text-white shadow-lg hover:from-blue-600 hover:to-blue-700 transition">üõ°Ô∏è CHR√ÅNEN√ù</button>
            <button onclick="stAction('status_grandchild')" class="bg-gradient-to-r from-green-700 to-green-800 p-5 rounded-lg text-white col-span-2 shadow-lg hover:from-green-600 hover:to-green-700 transition">üë∂ VNUK</button>
            <button onclick="closeSt()" class="w-full mt-5 text-gray-400 hover:text-white underline col-span-2 text-sm transition">Zavrie≈•</button>
        </div>
    </div>
</div>

<!-- NOTE Modal -->
<div id="noteModal" class="hidden fixed inset-0 bg-black/95 z-[4000] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-gradient-to-br from-gray-900 via-black to-gray-900 p-6 rounded-2xl border-2 border-blue-900 w-full max-w-sm max-h-[80vh] flex flex-col text-white shadow-2xl">
        <h2 id="noteTargetName" class="text-xl font-bold mb-5 uppercase text-center italic" style="font-family: 'Cinzel', serif;">Tip na rolu</h2>
        <div id="noteRoleList" class="flex-1 overflow-y-auto grid grid-cols-2 gap-2 text-[10px] font-bold"></div>
        <button onclick="closeNote()" class="mt-5 bg-gradient-to-r from-gray-800 to-gray-900 p-4 rounded-lg font-bold uppercase text-xs shadow-lg hover:from-gray-700 hover:to-gray-800 transition">Zavrie≈•</button>
    </div>
</div>

<!-- VOTING Modal -->
<div id="votingModal" class="hidden fixed inset-0 bg-black/95 z-[4000] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-gradient-to-br from-gray-900 via-black to-gray-900 p-8 rounded-2xl border-2 border-orange-900 w-full max-w-4xl max-h-[90vh] flex flex-col text-white shadow-2xl">
        <h2 id="votingTitle" class="text-2xl font-bold mb-6 text-center uppercase italic" style="font-family: 'Cinzel', serif;">Hlasovanie</h2>
        <div id="votingControls" class="mb-6 flex justify-center gap-4"></div>
        <div id="votingCards" class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </div>
</div>

<!-- TIMER Modal (ST only) -->
<div id="timerModal" class="hidden fixed inset-0 bg-black/90 z-[4500] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="modal-inner p-6 w-full max-w-sm text-white" style="background:linear-gradient(135deg,#0b0a0d 0%,#1a0f13 100%); border:2px solid #8b0000; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,0.6);">
        <h2 class="text-2xl font-black uppercase italic text-center mb-4" style="font-family:'Cinzel',serif">Odpoƒç√≠tavanie</h2>
        <div class="space-y-3">
            <label class="text-xs uppercase tracking-widest text-gray-400">Min√∫ty</label>
            <input id="timerMinutes" type="number" min="1" max="180" value="10" class="w-full bg-black/60 border-2 border-gray-800 text-white rounded-lg p-3 focus:border-red-700 outline-none">
            <div class="grid grid-cols-2 gap-3 mt-3">
                <button onclick="startTimerFromModal()" class="st-btn st-btn-time p-3 text-sm">‚ñ∂Ô∏è Spusti≈•</button>
                <button onclick="closeTimerModal()" class="st-btn st-btn-reset p-3 text-sm">‚úñÔ∏è Zavrie≈•</button>
            </div>
            <div class="grid grid-cols-3 gap-3 mt-2">
                <button onclick="pauseTimer()" class="st-btn st-btn-time p-3 text-xs">‚è∏Ô∏è Pozastavi≈•</button>
                <button onclick="resumeTimer()" class="st-btn st-btn-time p-3 text-xs">‚èµ Pokraƒçova≈•</button>
                <button onclick="resetTimer()" class="st-btn st-btn-reset p-3 text-xs">‚ü≤ Reset</button>
            </div>
        </div>
    </div>
</div>

<script>
    /* ===== Supabase ===== */
    const u = 'https://frenqgaxsezwukljnwqe.supabase.co';
    const k = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyZW5xZ2F4c2V6d3VrbGpud3FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MDU5NzUsImV4cCI6MjA4MzE4MTk3NX0.yTEWdNtl-vtr3o6mJZ1eEd8Ut2qo_pGlE1LjxybRLk8';
    const sb = supabase.createClient(u, k);

    let myId = localStorage.getItem('m_id'), roomCode = null, isST = false, players = [], myNotes = JSON.parse(localStorage.getItem('m_notes') || '{}'), activeTarget = null, activeChatId = null, unreadMessages = {}, syncInterval = null, lastSyncData = null, currentGameState = null;
    let globalMessages = [];
    let isRevealing = false;

    /* ===== (Len tikanie) Minimal AudioContext pre tick zvuk ===== */
    let tickAudioCtx = null;
    function ensureTickAudio() {
        if (!tickAudioCtx) {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            tickAudioCtx = new Ctx();
        }
        // iOS: resume ak bolo suspendnut√©
        if (tickAudioCtx.state === 'suspended') {
            tickAudioCtx.resume().catch(()=>{});
        }
    }
    function playTick() {
        try {
            ensureTickAudio();
            const osc = tickAudioCtx.createOscillator();
            const gain = tickAudioCtx.createGain();
            osc.type = 'square';
            osc.frequency.value = 900;
            gain.gain.value = 0.0;

            osc.connect(gain); gain.connect(tickAudioCtx.destination);
            const t = tickAudioCtx.currentTime;
            osc.start(t);
            gain.gain.setTargetAtTime(0.23, t, 0.001);
            gain.gain.setTargetAtTime(0.0001, t + 0.08, 0.01);
            osc.stop(t + 0.12);
        } catch(e) {
            // bezpeƒçne ignoruj (napr. ak prehliadaƒç blokne audio)
            console.warn('Tick sound failed:', e);
        }
    }

    /* ===== Hra ‚Äì logika + timer ===== */

    const ROLES_DATA = {
        DEMON: { "MIGMIGMAN": "Ka≈æd√∫ noc mus√≠ zabi≈• jedn√©ho hr√°ƒça, ale m√¥≈æe aj streli≈• do m≈ïtvoly." },
        POMOCNICI: { 
            "TR√ÅVIƒå": "Ka≈æd√∫ noc m√¥≈æe otr√°vi≈• jedn√©ho hr√°ƒça. Otr√°ven√©mu hr√°ƒçovi schopnos≈• dan√∫ noc a de≈à nefunguje.",
            "≈†ARLOTOV√Å D√ÅMA": "Akon√°hle bude D√©mon popraven√Ω tak sa ≈†D stane D√©monom.",
            "≈†PI√ìN": "Ka≈æd√∫ noc dostane info o roli jedn√©ho vybran√©ho hr√°ƒça.",
            "MIGAL": "Ak je v hre, 1 z dedinƒçanov sa st√°va opilcom. Migal o tom vie, ale opilec netu≈°√≠, ≈æe je opit√Ω."
        },
        PODIVINI: { 
            "OPILEC": "mysl√≠ si, ≈æe m√° in√∫ rolu, ne≈æ v skutoƒçnosti m√°. To znamen√°, ≈æe jeho schopnos≈• nefunguje spr√°vne.",
            "ANDEL": "Ak bude Anjel popraven√Ω poƒças d≈àa, dobro okam≈æite prehr√°.",
            "NE≈†IKA": "keƒè zomrie≈°, mus√≠≈° vybra≈• hr√°ƒça; ak je zl√Ω, dobro prehr√°.",
            "≈†A≈†O": "Pre v≈°etky schopnosti Dedinƒçanov sa jav√≠ ako ZLO.",
            "BABIƒåKA": "Vie kto je jej VNUK a ma na starosti ho chr√°ni≈•.(Ked je v hre babiƒçka je tam aj vnuk, no vnuk sa neberie ako Podiv√≠n)",
            "VNUK": "Ked zomrie≈° , zomiera aj tvoja BABIƒåKA (O tom, ≈æe je VNUK hr√°ƒç nevie a m√° norm√°lne priraden√∫ rolu od Dedinƒçanov)."
        },
        DEDINCANIA: { 
            "VOJAK": "Nem√¥≈æe by≈• zabit√Ω D√©monom v noci.",
            "DETEKT√çV": "Ka≈æd√∫ noc vyberie 2 hr√°ƒçov a zist√≠, ƒçi je aspo≈à 1 zl√Ω",
            "OCHRANCA": "Ka≈æd√∫ noc vyberie hr√°ƒça na ochranu. Ak tento hr√°ƒç zomrie, Ochranca zomrie miesto neho.",
            "HROBN√çK": "Ak je niekto popraven√Ω ( Nie zabit√Ω D√©monom) , n√°sledn√∫ noc zisti ako rola bol.",
            "LOVEC": "Raz za hru poƒças d≈àa m√¥≈æe vystreli≈• na hr√°ƒça, pokiaƒæ to bol D√©mon tak zomrie.",
            "VE≈†TKY≈áA": "Ka≈æd√∫ noc vyberie 2 hr√°ƒçov a zist√≠, ƒçi je jeden z nich D√©mon.",
            "DRBNA": "Na zaƒçiatku hry dostane info o tom, ≈æe 1 z 2 hr√°ƒçov je nejak√° rola.",
            "HAVRAN": "Ak je HAVRAN v noci zabit√Ω, dostane info o roli hr√°ƒça, ktor√©ho si e≈°te v tu noc vyberie.",
            "GEMBL√âR": "Ka≈æd√∫ noc m√¥≈æe vybra≈• jedn√©ho hr√°ƒça, ak to je zl√Ω tak to zist√≠, ak ale bol dobr√Ω, GEMBL√âR zomiera.",
            "STAROSTA": "Pokiaƒæ je ≈æiv√Ω jeho hlas ma hodnotu za 2 ƒæud√≠, akon√°hle zomrie je z neho obyƒçajn√Ω dedinƒçan ."
        }
    };

    const SETUP = { 5:[1,1,1,2], 6:[1,1,1,3], 7:[1,1,2,3], 8:[1,1,3,3], 9:[1,2,2,4], 10:[1,2,2,5], 11:[1,2,3,5], 12:[1,3,2,6] };
    const ROLE_CATEGORIES = {
        villagers: new Set(Object.keys(ROLES_DATA.DEDINCANIA)),
        outsiders: new Set(Object.keys(ROLES_DATA.PODIVINI)),
        evil: new Set([...Object.keys(ROLES_DATA.DEMON), ...Object.keys(ROLES_DATA.POMOCNICI)])
    };

    function getRoleTextColor(roleName) {
        if (!roleName) return "text-gray-500";
        if (ROLE_CATEGORIES.villagers.has(roleName)) return "text-green-400";
        if (ROLE_CATEGORIES.outsiders.has(roleName)) return "text-orange-400";
        return "text-red-400";
    }
    function getRoleColorClass(roleName) {
        if (!roleName) return "";
        if (ROLE_CATEGORIES.villagers.has(roleName)) return "border-villager";
        if (ROLE_CATEGORIES.outsiders.has(roleName)) return "border-outsider";
        return "border-evil"; 
    }

    async function enterGame(asST) {
        try {
            isST = asST; 
            roomCode = document.getElementById('joinRoom').value.trim().toUpperCase();
            if(!roomCode) { alert('Pros√≠m, zadaj k√≥d miestnosti.'); return; }

            if (isST) { 
                myId = 'st_' + roomCode; 
                const { error } = await sb.from('game_state').upsert({ room_code: roomCode, is_night: false, timer_running: false }); 
                if (error) { console.error(error); alert('Nepodarilo sa inicializova≈• miestnos≈•. Pozri konzolu.'); return; }
            } else { 
                const n = document.getElementById('joinName').value.trim(); 
                if(!n) { alert('Pros√≠m, zadaj svoje meno.'); return; }
                myId = 'p_' + Date.now(); 
                const { error } = await sb.from('players').insert([{ id_custom: myId, name: n, room_code: roomCode, position: Date.now() }]); 
                if (error) { console.error(error); alert('Nepodarilo sa prida≈• hr√°ƒça. Pozri konzolu.'); return; }
            }
            localStorage.setItem('m_id', myId);
            document.getElementById('lobby').classList.add('hidden'); document.getElementById('gameRoot').classList.remove('hidden');
            await sync();
            if (!syncInterval) syncInterval = setInterval(sync, 1000);
        } catch (e) {
            console.error('enterGame fatal:', e);
            alert('Nepodarilo sa pripoji≈• do hry. Pozri konzolu.');
        }
    }

    async function sync() {
        try {
            const [playersRes, gameStateRes, msgsRes] = await Promise.all([
                sb.from('players').select('*').eq('room_code', roomCode).order('id', { ascending: true }),
                sb.from('game_state').select('*').eq('room_code', roomCode).maybeSingle(),
                sb.from('messages').select('*').eq('room_code', roomCode).order('created_at')
            ]);
            
            if(msgsRes.data) { globalMessages = msgsRes.data; }

            const newData = JSON.stringify({ players: playersRes.data, gameState: gameStateRes.data });
            if (newData !== lastSyncData) {
                lastSyncData = newData;
                
                players = playersRes.data || [];
                players.sort((a, b) => a.position - b.position);
                currentGameState = gameStateRes.data;
                
                const aliveCount = players.filter(p => !p.is_dead).length;
                document.getElementById('aliveCounter').innerText = `≈Ωiv√≠: ${aliveCount} / ${players.length}`;

                if(gameStateRes.data) {
                    const b = document.getElementById('curTime'), h = document.getElementById('mainHeader');
                    const body = document.body;
                    const isNight = !!gameStateRes.data.is_night;

                    if (isNight) { 
                        b.textContent = 'üåô NOC'; 
                        b.className = 'time-badge badge-night'; 
                        h.className = 'col-span-3 flex items-center justify-between px-8 is-night'; 
                        body.classList.add('night-mode');
                    } else { 
                        b.textContent = '‚òÄÔ∏è DE≈á'; 
                        b.className = 'time-badge badge-day'; 
                        h.className = 'col-span-3 flex items-center justify-between px-8 is-day'; 
                        body.classList.remove('night-mode');
                    }
                }

                // Voting logic
                if (currentGameState && currentGameState.voting_active) {
                    const votingButtons = document.getElementById('votingButtons');

                    if (isST && !currentGameState.votes_revealed) {
                        renderVoting(currentGameState);
                    } else {
                        document.getElementById('votingModal').classList.add('hidden');
                    }

                    if (!isST) {
                        const alreadyVoted = !!(currentGameState.votes && currentGameState.votes[myId]);
                        const shouldShowVoteButtons = currentGameState.voting_active && !currentGameState.votes_revealed && !alreadyVoted;
                        votingButtons.classList.toggle('hidden', !shouldShowVoteButtons);
                        if (!shouldShowVoteButtons) votingButtons.innerHTML = `
                            <button id="voteYesBtn" class="vote-btn vote-yes">√ÅNO</button>
                            <button id="voteNoBtn" class="vote-btn vote-no">NIE</button>`;
                    } else {
                        votingButtons.innerHTML = '<button onclick="endVoting()" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-lg font-bold uppercase">Ukonƒçi≈• hlasovanie</button>';
                        votingButtons.classList.toggle('hidden', !currentGameState.votes_revealed);
                    }

                    if (currentGameState.votes_revealed && !isRevealing) {
                        isRevealing = true;
                        startRevealAnimation();
                    }
                } else {
                    document.getElementById('votingModal').classList.add('hidden');
                    document.getElementById('votingButtons').classList.add('hidden');
                    const hand = document.getElementById('clockHand');
                    if (hand) hand.remove();
                    document.querySelectorAll('.vote-token').forEach(t => t.remove());
                    isRevealing = false;
                }
                
                const me = players.find(p => p.id_custom === myId);
                if(!isST && me) {
                    const roleColor = getRoleTextColor(me.role);
                    document.getElementById('myInfo').innerHTML = `${me.name} | <b class="${roleColor} uppercase font-black">${me.role || 'ƒåAK√Å SA NA ROLU'}</b>`;
                } else if(isST) { 
                    document.getElementById('stControls').classList.remove('hidden'); 
                    document.getElementById('myInfo').textContent = "STORYTELLER"; 
                }
                
                renderTable(); 
                renderGrimoire();
            }

            // Timer render v≈ædy
            currentGameState = gameStateRes.data;
            renderTimer();

            renderChats(); 

            // napojenie tlaƒçidiel √ÅNO/NIE po re-rendere
            const yes = document.getElementById('voteYesBtn');
            const no  = document.getElementById('voteNoBtn');
            if (yes && !yes.dataset.bound) { yes.addEventListener('click', () => vote('yes')); yes.dataset.bound = '1'; }
            if (no  && !no.dataset.bound)  { no.addEventListener('click',  () => vote('no'));  no.dataset.bound  = '1'; }

        } catch (error) {
            console.error('Sync error:', error);
        }
    }

    function renderGrimoire() {
        const list = document.getElementById('roleList');
        const COLORS = { DEDINCANIA: 'text-green-400', PODIVINI: 'text-orange-400', DEMON: 'text-red-400', POMOCNICI: 'text-red-400' };
        const fragments = [];

        if (isST) {
            fragments.push('<h3 class="section-header text-[9px] font-black text-red-500 mb-2 border-b border-gray-800 uppercase text-center pb-1 tracking-widest">ST PREHƒΩAD</h3>');
            fragments.push('<table class="st-table mb-4"><thead><tr><th>Hr√°ƒç</th><th>Rola</th></tr></thead><tbody>');
            
            players.forEach(p => {
                const roleColor = getRoleTextColor(p.role);
                let statuses = '';
                if(p.status_drunk) statuses += 'üç∫';
                if(p.status_poisoned) statuses += 'üß™';
                if(p.status_protected) statuses += 'üõ°Ô∏è';
                if(p.status_grandchild) statuses += 'üë∂';

                fragments.push(`
                    <tr>
                        <td class="text-white font-bold">${p.name} ${p.is_dead ? 'üíÄ' : ''}</td>
                        <td class="${roleColor} font-bold">${p.role || '?'} ${statuses}</td>
                    </tr>
                `);
            });
            
            fragments.push('</tbody></table><div class="my-3 border-t border-red-900/30"></div>');
        }

        fragments.push('<h3 class="section-header text-[9px] font-black text-gray-500 mb-2 border-b border-gray-800 uppercase text-center pb-1">Grimo√°r</h3>');
        
        Object.entries(ROLES_DATA).forEach(([cat, roles]) => { 
            fragments.push(`<h4 class="${COLORS[cat]} font-black mt-4 border-b border-gray-800 uppercase pb-1.5 tracking-widest text-xs" style="font-family: 'Cinzel', serif;">${cat}</h4>`); 
            Object.entries(roles).forEach(([r, d]) => { 
                fragments.push(`<div class="mb-3 leading-relaxed"><b class="text-white font-black text-sm">${r}</b><br><span class="text-gray-300 text-xs font-semibold">${d}</span></div>`); 
            }); 
        });

        list.innerHTML = fragments.join('');
    }

    function renderTable() {
        const container = document.getElementById('tableCircle');
        const cw = container.offsetWidth || container.clientWidth;
        const ch = container.offsetHeight || container.clientHeight;
        if (!cw || !ch || players.length === 0) return;

        const radius = Math.min(cw, ch) / 2.8;
        const fragment = document.createDocumentFragment();
        
        const hasNomination = players.some(p => p.is_nominated);
        document.querySelector('.grid-layout').classList.toggle('has-nomination', hasNomination);

        players.forEach((p, i) => {
            let card = document.getElementById(`card-${p.id_custom}`);
            const isNew = !card;
            
            if(isNew) { 
                card = document.createElement('div'); 
                card.id = `card-${p.id_custom}`; 
                card.className = 'player-card'; 
            }
            
            let classes = `player-card ${p.is_dead ? 'dead' : ''}`;
            if (p.is_nominated) classes += ' nominated';
            card.className = classes;
            
            const angle = (i * 2 * Math.PI) / players.length;
            card.style.left = (cw/2 + radius * Math.cos(angle)) + 'px'; 
            card.style.top = (ch/2 + radius * Math.sin(angle)) + 'px';
            
            const roleToColor = isST ? p.role : myNotes[p.id_custom];
            const colorClass = getRoleColorClass(roleToColor);
            const label = isST ? (p.role || '?') : (p.id_custom === myId ? 'TY' : 'üë§');

            let statusIcon = "";
            if (isST) {
                if (p.status_drunk)     statusIcon += "üç∫";
                if (p.status_poisoned)  statusIcon += "üß™";
                if (p.status_protected) statusIcon += "üõ°Ô∏è";
                if (p.status_grandchild)statusIcon += "üë∂";
            }

            card.innerHTML = `
                ${p.is_nominated ? '<div class="nomination-arrow">üîª</div>' : ''}
                ${p.has_voted ? '<div class="paprcka">üñêÔ∏è</div>' : ''}
                <div class="token ${colorClass}" onclick="handleTokenClick('${p.id_custom}')">
                    <span class="text-[10px] text-gray-400 font-bold uppercase">${label}</span>
                    ${statusIcon ? `<div class="status-badge">${statusIcon}</div>` : ''}
                    ${myNotes[p.id_custom] ? `<div class="player-note">${myNotes[p.id_custom]}</div>` : ''}
                </div>
                <div class="text-xs font-black text-white uppercase truncate px-1" style="font-family: 'Cinzel', serif; letter-spacing: 1px;">${p.name}</div>`;
            
            if(isNew) fragment.appendChild(card);
        });
        
        if(fragment.hasChildNodes()) container.appendChild(fragment);
        
        const hand = document.getElementById('clockHand');
        if (currentGameState && currentGameState.voting_active && !currentGameState.votes_revealed) {
            // bez ruƒçiƒçky poƒças zberu
        } else {
            if (hand) hand.remove();
        }
    }

    async function stAction(field) { 
        if(!activeTarget) return; 
        
        if(field === 'is_nominated') {
            await sb.from('game_state').update({ 
                voting_active: true, 
                nominated_player: activeTarget.id_custom, 
                votes: {},
                votes_revealed: false
            }).eq('room_code', roomCode);
            closeSt();
            return;
        }

        const newValue = !activeTarget[field]; 
        await sb.from('players').update({ [field]: newValue }).eq('id_custom', activeTarget.id_custom); 
        sync(); 
    }

    function handleTokenClick(tid) { 
        const p = players.find(x => x.id_custom === tid); 
        if(isST) { 
            activeTarget = p; 
            document.getElementById('targetName').innerText = p.name; 
            document.getElementById('stModal').classList.remove('hidden'); 
        } else if(tid === myId) {
            toggleVote(); 
        } else {
            openNoteModal(p); 
        }
    }

    async function toggleVote() { 
        const me = players.find(p => p.id_custom === myId); 
        await sb.from('players').update({ has_voted: !me.has_voted }).eq('id_custom', myId); 
    }

    async function vote(choice) {
        const gameStateRes = await sb.from('game_state').select('votes').eq('room_code', roomCode).maybeSingle();
        const currentVotes = gameStateRes.data?.votes || {};
        currentVotes[myId] = choice;
        await sb.from('game_state').update({ votes: currentVotes }).eq('room_code', roomCode);
        sync();
    }

    async function revealVotes() {
        await sb.from('game_state').update({ votes_revealed: true }).eq('room_code', roomCode);
        document.getElementById('votingModal').classList.add('hidden');
    }

    function startRevealAnimation() {
        document.querySelectorAll('.vote-token').forEach(t => t.remove());

        const aliveIndices = players.map((p, i) => p.is_dead ? -1 : i).filter(i => i !== -1);
        const nominatedPlayerIndex = players.findIndex(p => p.id_custom === currentGameState.nominated_player);
        let yesCount = 0;
        
        const container = document.getElementById('tableCircle');
        const cw = container.offsetWidth || container.clientWidth;
        const ch = container.offsetHeight || container.clientHeight;
        const radius = Math.min(cw, ch) / 2.8;
        const angleDeg = (nominatedPlayerIndex * 360) / players.length;
        let hand = document.getElementById('clockHand');
        if (!hand) {
            hand = document.createElement('div');
            hand.id = 'clockHand';
            hand.style.position = 'absolute';
            hand.style.left = '50%';
            hand.style.top = '50%';
            hand.style.width = '8px';
            hand.style.height = (radius * 0.6) + 'px';
            hand.style.background = 'red';
            hand.style.transformOrigin = 'bottom center';
            hand.style.zIndex = '10';
            hand.style.borderRadius = '4px';
            hand.style.boxShadow = '0 0 10px rgba(255, 255, 0, 0.8)';
            container.appendChild(hand);
        }
        hand.style.transform = `translate(-50%, -100%) rotate(${angleDeg}deg)`;
        hand.style.animation = 'rotate 1s linear infinite';
        
        let tokenIndex = 0;
        const interval = setInterval(() => {
            if (tokenIndex < aliveIndices.length) {
                const playerIndex = aliveIndices[tokenIndex];
                const p = players[playerIndex];
                const vote = currentGameState.votes ? currentGameState.votes[p.id_custom] : null;
                
                let tokenHtml = '';
                if (vote === 'yes') {
                    yesCount++;
                    tokenHtml = `<div class="vote-token yes-token">${yesCount}</div>`;
                } else {
                    tokenHtml = `<div class="vote-token no-token">‚ùå</div>`;
                }
                const card = document.getElementById(`card-${p.id_custom}`);
                if (card) {
                    card.insertAdjacentHTML('beforeend', tokenHtml);
                }
                
                tokenIndex++;
            } else {
                clearInterval(interval);
                hand.style.animation = '';
                hand.remove();
                isRevealing = false;
                const votingButtons = document.getElementById('votingButtons');
                if (isST) {
                    votingButtons.classList.remove('hidden');
                }
            }
        }, 1000);
    }

    async function cancelVoting() {
        await sb.from('game_state').update({ 
            voting_active: false, 
            nominated_player: null, 
            votes: {}, 
            votes_revealed: false 
        }).eq('room_code', roomCode);
        document.getElementById('votingModal').classList.add('hidden');
        document.querySelectorAll('.vote-token').forEach(t => t.remove());
        const hand = document.getElementById('clockHand');
        if (hand) hand.remove();
        isRevealing = false;
    }

    async function endVoting() {
        await sb.from('game_state').update({ 
            voting_active: false, 
            nominated_player: null, 
            votes: {}, 
            votes_revealed: false 
        }).eq('room_code', roomCode);
        document.getElementById('votingModal').classList.add('hidden');
        document.querySelectorAll('.vote-token').forEach(t => t.remove());
        const hand = document.getElementById('clockHand');
        if (hand) hand.remove();
        isRevealing = false;
    }

    function renderVoting(gameState) {
        const modal = document.getElementById('votingModal');
        const title = document.getElementById('votingTitle');
        const cards = document.getElementById('votingCards');
        const controls = document.getElementById('votingControls');
        
        const nominated = players.find(p => p.id_custom === gameState.nominated_player);
        if (!nominated) return;
        
        title.innerText = `Hlasovanie pre ${nominated.name}`;
        
        const alivePlayers = players.filter(p => !p.is_dead);
        const votes = gameState.votes || {};
        const allVoted = alivePlayers.every(p => votes[p.id_custom]);
        
        const fragments = alivePlayers.map(p => {
            const vote = votes[p.id_custom];
            let cardClass = 'voting-card';
            let voteDisplay = '';
            
            if (vote === 'yes') {
                cardClass += ' voted-yes';
                voteDisplay = '‚úÖ √Åno';
            } else if (vote === 'no') {
                cardClass += ' voted-no';
                voteDisplay = '‚ùå Nie';
            } else {
                voteDisplay = 'ƒåak√° sa na hlas...';
            }
            
            return `
                <div class="${cardClass}">
                    <div class="font-bold text-lg mb-2">${p.name}</div>
                    <div class="text-sm">${voteDisplay}</div>
                </div>
            `;
        });
        
        cards.innerHTML = fragments.join('');
        
        if (isST) {
            controls.innerHTML = allVoted ? 
                '<button onclick="revealVotes()" class="bg-gradient-to-r from-blue-700 to-blue-600 hover:from-blue-600 hover:to-blue-500 p-4 rounded-lg text-white font-bold uppercase shadow-lg transition">Zobrazi≈• hlasy</button>' +
                '<button onclick="endVoting()" class="bg-gradient-to-r from-red-700 to-red-800 hover:from-red-600 hover:to-red-700 p-4 rounded-lg text-white font-bold uppercase shadow-lg transition">Ukonƒçi≈• hlasovanie</button>' :
                '<button onclick="cancelVoting()" class="bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 p-4 rounded-lg text-white font-bold uppercase shadow-lg transition">Zru≈°i≈• hlasovanie</button>';
        } else {
            controls.innerHTML = '';
        }
        
        modal.classList.remove('hidden');
    }

    async function distributeRoles() {
        const count = players.length; if(!SETUP[count]) return alert("Potrebujete 5-12 hr√°ƒçov!");
        const [dCount, pCount, subCount, villCount] = SETUP[count];
        let pool = []; 
        pool.push(...shuffle(Object.keys(ROLES_DATA.DEMON)).slice(0, dCount)); 
        pool.push(...shuffle(Object.keys(ROLES_DATA.POMOCNICI)).slice(0, pCount)); 
        pool.push(...shuffle(Object.keys(ROLES_DATA.PODIVINI).filter(r=>r!=='OPILEC'&&r!=='VNUK')).slice(0, subCount)); 
        pool.push(...shuffle(Object.keys(ROLES_DATA.DEDINCANIA)).slice(0, villCount));
        pool = shuffle(pool);

        for(let i=0; i < players.length; i++) { 
            await sb.from('players').update({ 
                role: pool[i], 
                is_dead: false, 
                has_voted: false, 
                is_nominated: false,
                status_drunk: false,
                status_poisoned: false,
                status_protected: false,
                status_grandchild: false
            }).eq('id_custom', players[i].id_custom); 
        }
        alert("Role rozdan√©!"); sync();
    }

    function openNoteModal(p) { 
        activeTarget = p; document.getElementById('noteTargetName').innerText = p.name; const l = document.getElementById('noteRoleList'); l.innerHTML = `<button onclick="setNote('')" class="bg-gradient-to-r from-red-900 to-red-800 p-3 rounded-lg uppercase col-span-2 text-white shadow-lg hover:from-red-800 hover:to-red-700 transition">Zmaza≈•</button>`; 
        Object.entries(ROLES_DATA).forEach(([cat, roles]) => {
            let color = cat === 'DEDINCANIA' ? 'from-green-700 to-green-800 hover:from-green-600 hover:to-green-700' : (cat === 'PODIVINI') ? 'from-orange-600 to-orange-700 hover:from-orange-500 hover:to-orange-600' : 'from-red-700 to-red-800 hover:from-red-600 hover:to-red-700';
            Object.keys(roles).forEach(role => { l.innerHTML += `<button onclick="setNote('${role}')" class="bg-gradient-to-r ${color} p-3 rounded-lg uppercase text-white shadow-lg transition">${role}</button>`; });
        });
        document.getElementById('noteModal').classList.remove('hidden'); 
    }

    function setNote(role) { myNotes[activeTarget.id_custom] = role; localStorage.setItem('m_notes', JSON.stringify(myNotes)); renderTable(); closeNote(); }
    function closeNote() { document.getElementById('noteModal').classList.add('hidden'); }
    function closeSt() { document.getElementById('stModal').classList.add('hidden'); }

    async function toggleTime() { 
        const { data: gs } = await sb.from('game_state').select('*').eq('room_code', roomCode).single(); 
        await sb.from('game_state').update({ is_night: !gs.is_night }).eq('room_code', roomCode); 
    }

    function renderChats() {
        const container = document.getElementById('allChats');
        const contactsContainer = document.getElementById('chatContacts');
        let targets = [];
        
        if(!isST) {
            contactsContainer.classList.add('hidden');
            container.classList.remove('hidden');
            
            targets.push({ id: 'st_' + roomCode, name: 'Storyteller' }); 
            const myIdx = players.findIndex(p => p.id_custom === myId);
            if(myIdx !== -1 && players.length > 1) {
                const l = players[(myIdx + players.length - 1) % players.length], r = players[(myIdx + 1) % players.length];
                if(l && l.id_custom !== myId) targets.push({ id: l.id_custom, name: "‚¨Ö " + l.name }); 
                if(r && r.id_custom !== myId && r.id_custom !== l.id_custom) targets.push({ id: r.id_custom, name: "‚û° " + r.name });
            }
            
            container.querySelectorAll('[data-chat-id]').forEach(div => { 
                if(!targets.find(t => t.id === div.getAttribute('data-chat-id'))) div.remove(); 
            });
            
            targets.forEach(t => {
                if(!container.querySelector(`[data-chat-id="${t.id}"]`)) {
                    const div = document.createElement('div'); 
                    div.setAttribute('data-chat-id', t.id);
                    div.innerHTML = `<div class="section-header text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-wider">${t.name}</div><div id="box-${t.id}" class="chat-box"></div><div class="flex gap-2 mt-2"><input id="in-${t.id}" onkeydown="if(event.key==='Enter') send('${t.id}')" class="flex-1 bg-black border-2 border-gray-800 text-xs p-3 text-white outline-none rounded-lg focus:border-red-600 transition"><button onclick="send('${t.id}')" class="bg-gradient-to-r from-red-900 to-red-800 hover:from-red-800 hover:to-red-700 px-4 rounded-lg text-white font-bold shadow-lg transition">></button></div>`;
                    container.appendChild(div);
                }
                updateChatContent(t.id);
            });
        } else {
            players.forEach(p => targets.push({ id: p.id_custom, name: p.name }));
            
            if(activeChatId) {
                contactsContainer.classList.add('hidden');
                container.classList.remove('hidden');
            } else {
                contactsContainer.classList.remove('hidden');
                container.classList.add('hidden');
            }
            
            targets.forEach(t => {
                const myMsgs = globalMessages.filter(m => 
                    (m.sender_id === t.id && m.receiver_id === myId) || 
                    (m.sender_id === myId && m.receiver_id === t.id)
                );
                
                const storedLen = parseInt(sessionStorage.getItem(`len_${t.id}`) || '0');
                const currentLen = myMsgs.length;
                
                if (currentLen > storedLen && activeChatId !== t.id) {
                     unreadMessages[t.id] = (unreadMessages[t.id] || 0) + (currentLen - storedLen);
                     sessionStorage.setItem(`len_${t.id}`, currentLen); 
                } else if (activeChatId === t.id) {
                     unreadMessages[t.id] = 0;
                     sessionStorage.setItem(`len_${t.id}`, currentLen);
                }
            });

            contactsContainer.innerHTML = '';
            targets.forEach(t => {
                const contactDiv = document.createElement('div');
                contactDiv.className = `chat-contact ${activeChatId === t.id ? 'active' : ''}`;
                contactDiv.onclick = () => openChat(t.id);
                
                const unreadCount = unreadMessages[t.id] || 0;
                const badge = unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : '';
                
                contactDiv.innerHTML = `
                    <div class="font-bold text-white text-[10px] uppercase" style="font-family: 'Cinzel', serif;">${t.name}</div>
                    ${badge}
                `;
                contactsContainer.appendChild(contactDiv);
                
                if(!container.querySelector(`[data-chat-view="${t.id}"]`)) {
                    const chatView = document.createElement('div');
                    chatView.className = 'chat-view';
                    chatView.setAttribute('data-chat-view', t.id);
                    chatView.innerHTML = `
                        <div class="flex justify-between items-center border-b border-gray-800 mb-2 pb-1">
                            <div class="section-header text-xs font-bold text-white uppercase tracking-wider">${t.name}</div>
                            <button onclick="closeChat()" class="text-gray-500 hover:text-red-500 transition font-bold text-sm px-2">‚ùå</button>
                        </div>
                        <div id="box-${t.id}" class="chat-box flex-1 mb-2" style="height: auto; max-height: 60vh;"></div>
                        <div class="flex gap-2">
                            <input id="in-${t.id}" onkeydown="if(event.key==='Enter') send('${t.id}')" class="flex-1 bg-black border-2 border-gray-800 text-xs p-2 text-white outline-none rounded-lg focus:border-red-600 transition">
                            <button onclick="send('${t.id}')" class="bg-gradient-to-r from-red-900 to-red-800 hover:from-red-800 hover:to-red-700 px-3 rounded-lg text-white font-bold shadow-lg transition text-xs">></button>
                        </div>
                    `;
                    container.appendChild(chatView);
                }
                
                updateChatContent(t.id);
            });
            
            if(activeChatId) {
                container.querySelectorAll('.chat-view').forEach(view => {
                    view.classList.toggle('active', view.getAttribute('data-chat-view') === activeChatId);
                });
            }
        }
    }
    
    function openChat(chatId) {
        activeChatId = chatId;
        unreadMessages[chatId] = 0;
        const msgs = globalMessages.filter(m => (m.sender_id === chatId && m.receiver_id === myId) || (m.sender_id === myId && m.receiver_id === chatId));
        sessionStorage.setItem(`len_${chatId}`, msgs.length);
        renderChats();
    }
    function closeChat() { activeChatId = null; renderChats(); }

    function updateChatContent(tid) { 
        const ms = globalMessages.filter(m => 
            (m.sender_id === myId && m.receiver_id === tid) || 
            (m.sender_id === tid && m.receiver_id === myId)
        );
        
        const box = document.getElementById(`box-${tid}`); 
        if(box) {
            const newHTML = ms.map(m => `<div class="msg ${m.sender_id === myId ? 'msg-me' : 'msg-them'}">${m.text}</div>`).join('');
            if (box.children.length !== ms.length) {
                box.innerHTML = newHTML; 
                box.scrollTop = box.scrollHeight;
            }
        } 
    }

    async function send(tid) { 
        const inp = document.getElementById(`in-${tid}`); 
        if(!inp.value.trim()) return; 
        
        const optimisticMsg = { sender_id: myId, receiver_id: tid, text: inp.value, room_code: roomCode, created_at: new Date().toISOString() };
        globalMessages.push(optimisticMsg);
        updateChatContent(tid);

        await sb.from('messages').insert([{ sender_id: myId, receiver_id: tid, text: inp.value, room_code: roomCode }]); 
        inp.value = ''; 
        sync(); 
    }

    async function hardReset() { 
        if(confirm("Zmaza≈• hru?")) { 
            await sb.from('players').delete().eq('room_code', roomCode); 
            await sb.from('messages').delete().eq('room_code', roomCode); 
            await sb.from('game_state').delete().eq('room_code', roomCode);
            location.reload(); 
        } 
    }

    function shuffle(a) { 
        // Fisher‚ÄìYates
        for (let i=a.length-1; i>0; i--) {
            const j = Math.floor(Math.random()*(i+1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }

    // Voting buttons ‚Äì prv√© napojenie (zopakuje sa v sync po rerendere)
    document.getElementById('voteYesBtn').addEventListener('click', () => vote('yes'));
    document.getElementById('voteNoBtn').addEventListener('click', () => vote('no'));

    /* ===== TIMER ‚Äì shared cez game_state ===== */
    let timerTickInterval = null;
    let lastTickSecond = null;

    document.getElementById('roundTable').addEventListener('click', async (e) => {
        const isButton = e.target.closest('button');
        if (isButton) return;
        if (!isST) return;
        openTimerModal();
    });

    function openTimerModal(){ document.getElementById('timerModal').classList.remove('hidden'); }
    function closeTimerModal(){ document.getElementById('timerModal').classList.add('hidden'); }

    async function startTimerFromModal(){
        const minutes = parseInt(document.getElementById('timerMinutes').value, 10) || 10;
        lastTickSecond = null;
        await startTimer(minutes);
        closeTimerModal();
    }

    async function startTimer(minutes) {
        const total = Math.max(1, Math.min(180, minutes)) * 60;
        const endIso = new Date(Date.now() + total*1000).toISOString();
        await sb.from('game_state').update({
            timer_total_seconds: total,
            timer_end: endIso,
            timer_running: true,
            timer_remaining_seconds: total
        }).eq('room_code', roomCode);
        sync();
    }

    async function pauseTimer() {
        if (!currentGameState || !currentGameState.timer_running) return;
        const remaining = Math.max(0, Math.floor((new Date(currentGameState.timer_end).getTime() - Date.now())/1000));
        await sb.from('game_state').update({
            timer_running: false,
            timer_remaining_seconds: remaining,
            timer_end: null
        }).eq('room_code', roomCode);
        sync();
    }

    async function resumeTimer() {
        if (!currentGameState) return;
        const remaining = currentGameState.timer_remaining_seconds ?? 0;
        if (remaining <= 0) return;
        const endIso = new Date(Date.now() + remaining*1000).toISOString();
        await sb.from('game_state').update({
            timer_running: true,
            timer_end: endIso
        }).eq('room_code', roomCode);
        sync();
    }

    async function resetTimer() {
        await sb.from('game_state').update({
            timer_running: false,
            timer_end: null,
            timer_total_seconds: null,
            timer_remaining_seconds: null
        }).eq('room_code', roomCode);
        sync();
    }

    function renderTimer() {
        const overlay = document.getElementById('timerOverlay');
        if (!currentGameState) { overlay.classList.add('hidden'); stopTimerTick(); return; }
        const running = !!currentGameState.timer_running;
        const total = currentGameState.timer_total_seconds || 0;
        let remaining = 0;
        if (running && currentGameState.timer_end) {
            remaining = Math.max(0, Math.floor((new Date(currentGameState.timer_end).getTime() - Date.now())/1000));
        } else {
            remaining = Math.max(0, currentGameState.timer_remaining_seconds || 0);
        }
        if (total <= 0 && remaining <= 0) {
            overlay.classList.add('hidden');
            stopTimerTick();
            return;
        }

        overlay.classList.remove('hidden');

        const pct = total > 0 ? Math.floor(((total - remaining) / total) * 100) : 0;
        overlay.querySelector('.timer-ring').style.setProperty('--pct', pct + '%');
        const mm = String(Math.floor(remaining / 60)).padStart(2,'0');
        const ss = String(remaining % 60).padStart(2,'0');
        document.getElementById('timerText').textContent = `${mm}:${ss}`;
        document.getElementById('timerMini').textContent = running ? 'Be≈æ√≠...' : 'Pozastaven√©';

        if (running) {
            startTimerTick();
            if (remaining <= 5 && remaining >= 1) {
                if (lastTickSecond !== remaining) {
                    lastTickSecond = remaining;
                    playTick(); // ponechan√© tikanie
                }
            }
            if (remaining === 0) {
                stopTimerTick();
                // playBell();  // odstr√°nen√© podƒæa ≈æelania
                const rt = document.getElementById('roundTable');
                rt.classList.add('table-flash');
                setTimeout(()=>rt.classList.remove('table-flash'), 1800);
                if (isST) {
                    sb.from('game_state').update({
                        timer_running: false,
                        timer_end: null,
                        timer_remaining_seconds: 0
                    }).eq('room_code', roomCode);
                }
            }
        } else {
            stopTimerTick();
        }
    }

    function startTimerTick() { if (timerTickInterval) return; timerTickInterval = setInterval(renderTimer, 250); }
    function stopTimerTick() { if (timerTickInterval) { clearInterval(timerTickInterval); timerTickInterval = null; } }

    // Re-render kruhu pri resize
    window.addEventListener('resize', () => renderTable());
</script>
</body>
</html>
